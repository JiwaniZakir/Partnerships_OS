name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  lint-and-typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm typecheck

  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: fpos
          POSTGRES_PASSWORD: fpos_test
          POSTGRES_DB: fpos_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter @fpos/shared build
      - run: pnpm --filter @fpos/api exec prisma generate
      - run: pnpm --filter @fpos/api exec prisma migrate deploy
        env:
          DATABASE_URL: postgresql://fpos:fpos_test@localhost:5432/fpos_test
      - run: pnpm test --coverage
        env:
          DATABASE_URL: postgresql://fpos:fpos_test@localhost:5432/fpos_test
          REDIS_URL: redis://localhost:6379
          NODE_ENV: test
          GOOGLE_CLIENT_ID: test
          GOOGLE_CLIENT_SECRET: test
          JWT_PRIVATE_KEY: test
          JWT_PUBLIC_KEY: test
          ANTHROPIC_API_KEY: test
          OPENAI_API_KEY: test
          PII_ENCRYPTION_KEY: test_encryption_key_32_chars_long!

  docker-build:
    runs-on: ubuntu-latest
    needs: [lint-and-typecheck]
    steps:
      - uses: actions/checkout@v4
      - name: Build API Docker image
        run: docker build -f apps/api/Dockerfile -t fpos-api:ci .

  deploy-api:
    runs-on: ubuntu-latest
    needs: [test, docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to Railway
        if: env.RAILWAY_TOKEN != ''
        uses: bervProject/railway-deploy@main
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: fpos-api
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
